<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinket DPS Admin - WoW Loot Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>Trinket DPS Admin Panel</h1>
        </div>

        <div class="admin-controls">
            <button id="addTrinketBtn" class="btn btn-primary">Add New Trinket</button>
            <button id="exportBtn" class="btn btn-success">Export to JSON</button>
            <button id="importBtn" class="btn btn-secondary">Import from JSON</button>
            <button onclick="window.location.href='index.html'" class="btn btn-secondary">Back to Main</button>
        </div>

        <div id="trinketList" class="boss-list">
            <!-- Trinket list will be populated here -->
        </div>
    </div>

    <!-- Add/Edit Trinket Form -->
    <div id="editFormBackdrop" class="edit-form-backdrop" style="display: none;"></div>
    <div id="editForm" class="edit-form" style="display: none;">
        <h2 id="formTitle">Add New Trinket</h2>
        
        <div class="form-row">
            <div class="form-group">
                <label for="trinketId">Trinket ID:</label>
                <input type="text" id="trinketId" placeholder="e.g., 12345">
            </div>
            <div class="form-group">
                <label for="trinketName">Trinket Name:</label>
                <input type="text" id="trinketName" placeholder="e.g., Powerful Trinket">
            </div>
        </div>

        <div class="form-group">
            <label for="trinketIcon">Trinket Icon URL:</label>
            <input type="text" id="trinketIcon" placeholder="https://wowhead.com/icon/...">
        </div>

        <div class="form-group">
            <label>DPS Values by Spec:</label>
            <div class="spec-checkboxes" id="specDpsContainer">
                <!-- Spec DPS inputs will be generated here -->
            </div>
        </div>

        <div class="btn-group">
            <button id="saveTrinketBtn" class="btn btn-success btn-small">Save Trinket</button>
            <button id="cancelTrinketBtn" class="btn btn-secondary btn-small">Cancel</button>
            <button id="deleteTrinketBtn" class="btn btn-danger btn-small" style="display: none;">Delete Trinket</button>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script>
        // Spec data with icons (using the same icons as script.js)
        const specs = {
            // Warrior
            'warrior-arms': { name: 'Arms', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_savageblow.jpg' },
            'warrior-fury': { name: 'Fury', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_innerrage.jpg' },
            'warrior-protection': { name: 'Protection', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_warrior_defensivestance.jpg' },
            
            // Paladin
            'paladin-holy': { name: 'Holy', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_holybolt.jpg' },
            'paladin-protection': { name: 'Protection', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_devotionaura.jpg' },
            'paladin-retribution': { name: 'Retribution', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_auraoflight.jpg' },
            
            // Hunter
            'hunter-beast-mastery': { name: 'Beast Mastery', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_bestialdiscipline.jpg' },
            'hunter-marksmanship': { name: 'Marksmanship', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_focusedaim.jpg' },
            'hunter-survival': { name: 'Survival', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_hunter_camouflage.jpg' },
            
            // Rogue
            'rogue-assassination': { name: 'Assassination', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_rogue_deadlybrew.jpg' },
            'rogue-outlaw': { name: 'Outlaw', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_rogue_waylay.jpg' },
            'rogue-subtlety': { name: 'Subtlety', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_stealth.jpg' },
            
            // Priest
            'priest-discipline': { name: 'Discipline', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_powerwordshield.jpg' },
            'priest-holy': { name: 'Holy', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_guardianspirit.jpg' },
            'priest-shadow': { name: 'Shadow', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_shadowwordpain.jpg' },
            
            // Shaman
            'shaman-elemental': { name: 'Elemental', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_lightning.jpg' },
            'shaman-enhancement': { name: 'Enhancement', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_shaman_improvedstormstrike.jpg' },
            'shaman-restoration': { name: 'Restoration', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_magicimmunity.jpg' },
            
            // Mage
            'mage-arcane': { name: 'Arcane', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_holy_magicalsentry.jpg' },
            'mage-fire': { name: 'Fire', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_fire_firebolt02.jpg' },
            'mage-frost': { name: 'Frost', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_frost_frostbolt02.jpg' },
            
            // Warlock
            'warlock-affliction': { name: 'Affliction', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_deathcoil.jpg' },
            'warlock-demonology': { name: 'Demonology', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_metamorphosis.jpg' },
            'warlock-destruction': { name: 'Destruction', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_shadow_rainoffire.jpg' },
            
            // Death Knight
            'death-knight-blood': { name: 'Blood', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_deathknight_bloodpresence.jpg' },
            'death-knight-frost': { name: 'Frost', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_deathknight_frostpresence.jpg' },
            'death-knight-unholy': { name: 'Unholy', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_deathknight_unholypresence.jpg' },
            
            // Demon Hunter
            'demon-hunter-havoc': { name: 'Havoc', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_demonhunter_specdps.jpg' },
            'demon-hunter-vengeance': { name: 'Vengeance', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_demonhunter_spectank.jpg' },
            
            // Druid
            'druid-balance': { name: 'Balance', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_starfall.jpg' },
            'druid-feral': { name: 'Feral', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_druid_catform.jpg' },
            'druid-guardian': { name: 'Guardian', icon: 'https://wow.zamimg.com/images/wow/icons/large/ability_racial_bearform.jpg' },
            'druid-restoration': { name: 'Restoration', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_nature_healingtouch.jpg' },
            
            // Evoker
            'evoker-devastation': { name: 'Devastation', icon: 'https://wow.zamimg.com/images/wow/icons/large/classicon_evoker_devastation.jpg' },
            'evoker-preservation': { name: 'Preservation', icon: 'https://wow.zamimg.com/images/wow/icons/large/classicon_evoker_preservation.jpg' },
            'evoker-augmentation': { name: 'Augmentation', icon: 'https://wow.zamimg.com/images/wow/icons/large/classicon_evoker_augmentation.jpg' },
            
            // Monk
            'monk-brewmaster': { name: 'Brewmaster', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_monk_brewmaster_spec.jpg' },
            'monk-mistweaver': { name: 'Mistweaver', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_monk_mistweaver_spec.jpg' },
            'monk-windwalker': { name: 'Windwalker', icon: 'https://wow.zamimg.com/images/wow/icons/large/spell_monk_windwalker_spec.jpg' }
        };

        let trinketData = {};
        let editingTrinketId = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadTrinketData();
            generateSpecDpsInputs();
            setupEventListeners();
            displayTrinketList();
        });

        function loadTrinketData() {
            const saved = localStorage.getItem('trinketDpsData');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Handle both old format (direct trinket IDs) and new format (with "trinkets" wrapper)
                if (parsed.trinkets) {
                    trinketData = parsed.trinkets;
                } else {
                    trinketData = parsed;
                }
            }
        }

        function saveTrinketData() {
            // Save in the format that matches the existing JSON structure
            const dataToSave = {
                trinkets: trinketData
            };
            localStorage.setItem('trinketDpsData', JSON.stringify(dataToSave));
        }

        function generateSpecDpsInputs() {
            const container = document.getElementById('specDpsContainer');
            container.innerHTML = '';

            Object.keys(specs).forEach(specId => {
                const spec = specs[specId];
                const specDiv = document.createElement('div');
                specDiv.className = 'spec-checkbox';
                specDiv.innerHTML = `
                    <label>
                        <img src="${spec.icon}" alt="${spec.name}" class="spec-icon" onerror="this.style.display='none'">
                        <span>${spec.name}</span>
                    </label>
                    <div style="display: flex; gap: 10px; margin-left: auto;">
                        <input type="number" 
                               id="dps_${specId}_champion" 
                               placeholder="Champion DPS" 
                               step="1" 
                               style="width: 100px; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #e6e6e6;">
                        <input type="number" 
                               id="dps_${specId}_heroic" 
                               placeholder="Heroic DPS" 
                               step="1" 
                               style="width: 100px; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #e6e6e6;">
                        <input type="number" 
                               id="dps_${specId}_mythic" 
                               placeholder="Mythic DPS" 
                               step="1" 
                               style="width: 100px; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: #e6e6e6;">
                    </div>
                `;
                container.appendChild(specDiv);
            });
        }

        function setupEventListeners() {
            document.getElementById('addTrinketBtn').addEventListener('click', showAddForm);
            document.getElementById('saveTrinketBtn').addEventListener('click', saveTrinket);
            document.getElementById('cancelTrinketBtn').addEventListener('click', hideForm);
            document.getElementById('deleteTrinketBtn').addEventListener('click', deleteTrinket);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);
            document.getElementById('importFileInput').addEventListener('change', handleFileImport);
        }

        function showAddForm() {
            editingTrinketId = null;
            document.getElementById('formTitle').textContent = 'Add New Trinket';
            document.getElementById('trinketId').value = '';
            document.getElementById('trinketName').value = '';
            document.getElementById('trinketIcon').value = '';
            
            // Clear all DPS inputs
            Object.keys(specs).forEach(specId => {
                document.getElementById(`dps_${specId}_champion`).value = '';
                document.getElementById(`dps_${specId}_heroic`).value = '';
                document.getElementById(`dps_${specId}_mythic`).value = '';
            });
            
            document.getElementById('deleteTrinketBtn').style.display = 'none';
            showForm();
        }

        function showEditForm(trinketId) {
            editingTrinketId = trinketId;
            const trinket = trinketData[trinketId];
            
            document.getElementById('formTitle').textContent = 'Edit Trinket';
            document.getElementById('trinketId').value = trinketId;
            document.getElementById('trinketName').value = trinket.name || '';
            document.getElementById('trinketIcon').value = trinket.iconUrl || trinket.icon || '';
            
            // Fill DPS inputs
            Object.keys(specs).forEach(specId => {
                const championDps = trinket.champion?.dpsValues?.[specId] || '';
                const heroicDps = trinket.heroic?.dpsValues?.[specId] || '';
                const mythicDps = trinket.mythic?.dpsValues?.[specId] || '';
                document.getElementById(`dps_${specId}_champion`).value = championDps;
                document.getElementById(`dps_${specId}_heroic`).value = heroicDps;
                document.getElementById(`dps_${specId}_mythic`).value = mythicDps;
            });
            
            document.getElementById('deleteTrinketBtn').style.display = 'inline-block';
            showForm();
        }

        function showForm() {
            document.getElementById('editFormBackdrop').style.display = 'block';
            document.getElementById('editForm').style.display = 'block';
        }

        function hideForm() {
            document.getElementById('editFormBackdrop').style.display = 'none';
            document.getElementById('editForm').style.display = 'none';
        }

        function convertIconUrl(url) {
            if (!url) return url;
            
            // tiny -> large ve gif -> jpg dÃ¶nÃ¼ÅŸtÃ¼r
            let convertedUrl = url
                .replace('/icons/tiny/', '/icons/large/')
                .replace('.gif', '.jpg');
            
            console.log('ðŸ”„ URL dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldi:', url, '->', convertedUrl);
            return convertedUrl;
        }

        function saveTrinket() {
            const trinketId = document.getElementById('trinketId').value.trim();
            const trinketName = document.getElementById('trinketName').value.trim();
            const trinketIcon = document.getElementById('trinketIcon').value.trim();

            if (!trinketId || !trinketName) {
                alert('Please fill in Trinket ID and Name');
                return;
            }

            // Collect DPS values
            const championDpsValues = {};
            const heroicDpsValues = {};
            const mythicDpsValues = {};
            
            Object.keys(specs).forEach(specId => {
                const championDps = document.getElementById(`dps_${specId}_champion`).value;
                const heroicDps = document.getElementById(`dps_${specId}_heroic`).value;
                const mythicDps = document.getElementById(`dps_${specId}_mythic`).value;
                
                if (championDps) championDpsValues[specId] = parseFloat(championDps);
                if (heroicDps) heroicDpsValues[specId] = parseFloat(heroicDps);
                if (mythicDps) mythicDpsValues[specId] = parseFloat(mythicDps);
            });

            // Convert icon URL
            const convertedIconUrl = convertIconUrl(trinketIcon);

            // Create trinket data structure
            const trinketData = {
                name: trinketName,
                iconUrl: convertedIconUrl, // Use converted iconUrl to match existing format
                champion: {
                    dpsValues: championDpsValues
                },
                heroic: {
                    dpsValues: heroicDpsValues
                },
                mythic: {
                    dpsValues: mythicDpsValues
                }
            };

            // Save to localStorage
            const saved = localStorage.getItem('trinketDpsData');
            let allTrinketData;
            if (saved) {
                const parsed = JSON.parse(saved);
                allTrinketData = parsed.trinkets || parsed;
            } else {
                allTrinketData = {};
            }
            
            allTrinketData[trinketId] = trinketData;
            
            // Save in the correct format
            const dataToSave = {
                trinkets: allTrinketData
            };
            localStorage.setItem('trinketDpsData', JSON.stringify(dataToSave));

            hideForm();
            displayTrinketList();
            alert('Trinket saved successfully!');
        }

        function deleteTrinket() {
            if (!editingTrinketId) return;
            
            if (confirm('Are you sure you want to delete this trinket?')) {
                const saved = localStorage.getItem('trinketDpsData');
                let allTrinketData;
                if (saved) {
                    const parsed = JSON.parse(saved);
                    allTrinketData = parsed.trinkets || parsed;
                } else {
                    allTrinketData = {};
                }
                
                delete allTrinketData[editingTrinketId];
                
                // Save in the correct format
                const dataToSave = {
                    trinkets: allTrinketData
                };
                localStorage.setItem('trinketDpsData', JSON.stringify(dataToSave));
                
                hideForm();
                displayTrinketList();
                alert('Trinket deleted successfully!');
            }
        }

        function deleteTrinketFromList(trinketId) {
            if (confirm('Are you sure you want to delete this trinket?')) {
                const saved = localStorage.getItem('trinketDpsData');
                let allTrinketData;
                if (saved) {
                    const parsed = JSON.parse(saved);
                    allTrinketData = parsed.trinkets || parsed;
                } else {
                    allTrinketData = {};
                }
                
                delete allTrinketData[trinketId];
                
                // Save in the correct format
                const dataToSave = {
                    trinkets: allTrinketData
                };
                localStorage.setItem('trinketDpsData', JSON.stringify(dataToSave));
                
                displayTrinketList();
                alert('Trinket deleted successfully!');
            }
        }

        function displayTrinketList() {
            const container = document.getElementById('trinketList');
            const saved = localStorage.getItem('trinketDpsData');
            let allTrinketData = {};
            
            if (saved) {
                const parsed = JSON.parse(saved);
                allTrinketData = parsed.trinkets || parsed;
            }
            
            if (Object.keys(allTrinketData).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #d4af37; font-size: 1.2rem;">No trinkets added yet. Click "Add New Trinket" to get started.</p>';
                return;
            }

            container.innerHTML = '';
            
            Object.keys(allTrinketData).forEach(trinketId => {
                const trinket = allTrinketData[trinketId];
                const trinketCard = document.createElement('div');
                trinketCard.className = 'boss-card';
                
                const heroicSpecs = Object.keys(trinket.heroic?.dpsValues || {}).length;
                const mythicSpecs = Object.keys(trinket.mythic?.dpsValues || {}).length;
                
                trinketCard.innerHTML = `
                    <div class="boss-header">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            ${trinket.iconUrl || trinket.icon ? 
                                `<img src="${trinket.iconUrl || trinket.icon}" alt="${trinket.name}" class="item-icon" onerror="this.style.display='none'">` : 
                                `<div class="item-icon-fallback">ðŸ’Ž</div>`
                            }
                            <div>
                                <h3 style="margin: 0; color: #d4af37;">${trinket.name}</h3>
                                <p style="margin: 5px 0 0 0; color: #e6e6e6; font-size: 0.9rem;">ID: ${trinketId}</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="showEditForm('${trinketId}')" class="btn btn-primary btn-small">Edit</button>
                            <button onclick="deleteTrinketFromList('${trinketId}')" class="btn btn-danger btn-small">Delete</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4 style="color: #8e44ad; margin-bottom: 10px;">Heroic Version</h4>
                                                         <p style="color: #e6e6e6; font-size: 0.9rem;">DPS values for ${heroicSpecs} specs</p>
                         </div>
                         <div>
                             <h4 style="color: #9b59b6; margin-bottom: 10px;">Mythic Version</h4>
                             <p style="color: #e6e6e6; font-size: 0.9rem;">DPS values for ${mythicSpecs} specs</p>
                        </div>
                    </div>
                `;
                
                container.appendChild(trinketCard);
            });
        }

        function exportData() {
            const data = localStorage.getItem('trinketDpsData');
            if (!data || data === '{}') {
                alert('No trinket data to export');
                return;
            }

            // Ensure the exported data is in the correct format
            const parsed = JSON.parse(data);
            const exportData = parsed.trinkets ? parsed : { trinkets: parsed };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'trinket-dps-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Handle both formats (with or without "trinkets" wrapper)
                    const dataToSave = importedData.trinkets ? importedData : { trinkets: importedData };
                    localStorage.setItem('trinketDpsData', JSON.stringify(dataToSave));
                    displayTrinketList();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
    </script>
</body>
</html> 